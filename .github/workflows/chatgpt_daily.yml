name: Generate ChatGPT Article Daily

on:
  schedule:
    - cron: '0 8 * * *'  # Cháº¡y vÃ o 8:00 sÃ¡ng má»—i ngÃ y
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  generate_article:
    runs-on: ubuntu-latest

    steps:
      - name: Láº¥y code tá»« GitHub
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Äáº£m báº£o táº£i toÃ n bá»™ repo

      - name: Kiá»ƒm tra API Key
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ Lá»—i: API Key chÆ°a Ä‘Æ°á»£c thiáº¿t láº­p trong GitHub Secrets!"
            exit 1
          fi
          echo "âœ… API Key Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p."

      - name: Kiá»ƒm tra file prompt cÃ³ tá»“n táº¡i
        run: |
          if [[ ! -f prompts/article_prompt.txt ]]; then
            echo "âŒ Lá»—i: File prompts/article_prompt.txt khÃ´ng tá»“n táº¡i!"
            exit 1
          fi
          echo "âœ… File prompts/article_prompt.txt Ä‘Ã£ tá»“n táº¡i."

      - name: Äá»c Prompt tá»« GitHub
        run: |
          PROMPT=$(cat prompts/article_prompt.txt | tr '\n' ' ' | tr -d '\r')
          echo "Prompt Ä‘Æ°á»£c gá»­i Ä‘i: $PROMPT"
          echo "prompt=$PROMPT" >> "$GITHUB_ENV"

      - name: Kiá»ƒm tra giÃ¡ trá»‹ cá»§a Prompt
        run: |
          echo "ðŸ” Prompt Ä‘ang gá»­i Ä‘i: ${{ env.prompt }}"

      - name: Kiá»ƒm tra JSON trÆ°á»›c khi gá»­i API
        run: |
          JSON_DATA=$(jq -n \
          --arg model "gpt-4o" \
          --argjson content "$(echo '${{ env.prompt }}' | jq -R .)" \
          '{
            model: $model,
            messages: [{role: "system", content: $content}],
            max_tokens: 1500
          }')

          echo "âœ… JSON há»£p lá»‡:"
          echo "$JSON_DATA"

      - name: Gá»i ChatGPT API
        run: |
          JSON_DATA=$(jq -n \
          --arg model "gpt-4o" \
          --argjson content "$(echo '${{ env.prompt }}' | jq -R .)" \
          '{
            model: $model,
            messages: [{role: "system", content: $content}],
            max_tokens: 500
          }')

          RESPONSE=$(echo "$JSON_DATA" | curl -s -X POST "https://api.openai.com/v1/chat/completions" \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
          -H "Content-Type: application/json" \
          -d @-)

          echo "API Response: $RESPONSE"
          PARSED_RESPONSE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "Lá»—i tá»« API: KhÃ´ng cÃ³ pháº£n há»“i há»£p lá»‡"')
          echo "response=$PARSED_RESPONSE" >> "$GITHUB_ENV"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: LÆ°u bÃ i viáº¿t vÃ o Markdown
        run: |
          mkdir -p articles  # Äáº£m báº£o thÆ° má»¥c tá»“n táº¡i
          FILE_NAME="articles/article_$(date '+%Y-%m-%d').md"
          echo "# ÄÃ¨n nÄƒng lÆ°á»£ng máº·t trá»i - BÃ i Viáº¿t ChatGPT" > $FILE_NAME
          echo "${{ env.response }}" >> $FILE_NAME
          cat $FILE_NAME  # Hiá»ƒn thá»‹ ná»™i dung file trong log

      - name: Commit vÃ  Push bÃ i viáº¿t
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git add articles/
          git commit -m "Cáº­p nháº­t bÃ i viáº¿t tá»± Ä‘á»™ng ngÃ y $(date '+%Y-%m-%d')" || echo "KhÃ´ng cÃ³ thay Ä‘á»•i Ä‘á»ƒ commit"
          git push origin HEAD:main || echo "KhÃ´ng cÃ³ thay Ä‘á»•i Ä‘á»ƒ push"
