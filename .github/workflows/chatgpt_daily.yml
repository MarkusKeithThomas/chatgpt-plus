name: Generate ChatGPT Article Daily

on:
  schedule:
    - cron: '0 8 * * *'  # Chạy vào 8:00 sáng mỗi ngày
  workflow_dispatch:  # Cho phép chạy thủ công

jobs:
  generate_article:
    runs-on: ubuntu-latest

    steps:
      - name: Lấy code từ GitHub
        uses: actions/checkout@v3

      - name: Đọc Prompt từ GitHub
        run: |
          if [[ ! -f prompts/article_prompt.txt ]]; then
            echo "Lỗi: Không tìm thấy file prompts/article_prompt.txt"
            exit 1
          fi
          PROMPT=$(cat prompts/article_prompt.txt | tr '\n' ' ')
          echo "Prompt được gửi: $PROMPT"
          echo "prompt=$PROMPT" >> "$GITHUB_ENV"

      - name: Gọi ChatGPT API
        run: |
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
          -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "model": "gpt-4",
            "messages": [{"role": "system", "content": "'"${{ env.prompt }}"'"}],
            "max_tokens": 1500
          }' | jq -r '.choices[0].message.content // "Lỗi: Không có phản hồi từ API"')

          echo "API Response: $RESPONSE"
          echo "response=$RESPONSE" >> "$GITHUB_ENV"

      - name: Lưu bài viết vào Markdown
        run: |
          mkdir -p articles  # Đảm bảo thư mục tồn tại
          FILE_NAME="articles/article_$(date '+%Y-%m-%d').md"
          echo "# Đèn năng lượng mặt trời - Bài Viết ChatGPT" > $FILE_NAME
          echo "${{ env.response }}" >> $FILE_NAME
          cat $FILE_NAME  # Hiển thị nội dung file trong log

      - name: Commit và Push bài viết
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git add articles/
          git commit -m "Cập nhật bài viết tự động ngày $(date '+%Y-%m-%d')" || echo "Không có thay đổi để commit"
          git push origin HEAD:main || echo "Không có thay đổi để push"
